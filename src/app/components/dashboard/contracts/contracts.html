@if (!isLoading && !error) {
  <div class="contracts-container">
    <div class="header">
      <h2>Contracts</h2>
      <button mat-raised-button color="primary" (click)="openAddDialogForm()">Add Contract</button>
      <mat-form-field appearance="outline" class="search-field">
        <input matInput placeholder="Search" [(ngModel)]="searchText" (keyup)="applyFilter()" />
      </mat-form-field>
    </div>

    <mat-form-field appearance="outline" class="full-width mt-3">
      <mat-label>Select Property</mat-label>
      <mat-select [(ngModel)]="selectedPropertyId" (selectionChange)="filterContractsByProperty()">
        @for (property of properties; track property.id) {
          <mat-option [value]="property.id">
            {{ property.name }}
          </mat-option>
        }
      </mat-select>
    </mat-form-field>

    <!-- Active Contracts Table -->
    <div class="table-section">
      <h3 class="table-title active-title">
        <mat-icon>check_circle</mat-icon>
        Active Contracts ({{ activeDataSource.data.length }})
      </h3>
      <table mat-table [dataSource]="activeDataSource" class="mat-elevation-z8">
        <ng-container matColumnDef="contract_number">
          <th mat-header-cell *matHeaderCellDef>Contract #</th>
          <td mat-cell *matCellDef="let element">{{ element.contract_number || '‚Äî' }}</td>
        </ng-container>

        <ng-container matColumnDef="customer_name">
          <th mat-header-cell *matHeaderCellDef>Customer</th>
          <td mat-cell *matCellDef="let element">{{ element.customer_name }}</td>
        </ng-container>

        <ng-container matColumnDef="unit_info">
          <th mat-header-cell *matHeaderCellDef>Unit</th>
          <td mat-cell *matCellDef="let element">{{ element.unit_info }}</td>
        </ng-container>

        <ng-container matColumnDef="start_date">
          <th mat-header-cell *matHeaderCellDef>Start</th>
          <td mat-cell *matCellDef="let element">{{ element.start_date }}</td>
        </ng-container>

        <ng-container matColumnDef="rent_amount">
          <th mat-header-cell *matHeaderCellDef>Rent</th>
          <td mat-cell *matCellDef="let element">{{ element.rent_amount }}</td>
        </ng-container>

        <ng-container matColumnDef="deposit_amount">
          <th mat-header-cell *matHeaderCellDef>Deposit</th>
          <td mat-cell *matCellDef="let element">{{ element.deposit_amount }}</td>
        </ng-container>

        <ng-container matColumnDef="payment_frequency">
          <th mat-header-cell *matHeaderCellDef>Frequency</th>
          <td mat-cell *matCellDef="let element">{{ element.payment_frequency }}</td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let element">
            <button mat-icon-button color="primary" (click)="printContract(element)" matTooltip="Print Contract">
              <mat-icon>print</mat-icon>
            </button>
            <button mat-icon-button color="primary" (click)="openEditDialog(element)" matTooltip="Edit">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button color="accent" (click)="openCancelDialog(element)" matTooltip="Cancel Contract">
              <mat-icon>block</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="active-row"></tr>
      </table>
      <mat-paginator #activePaginator [pageSizeOptions]="[5, 10, 25]" showFirstLastButtons></mat-paginator>
    </div>

    <!-- Inactive Contracts Table -->
    <div class="table-section">
      <h3 class="table-title inactive-title">
        <mat-icon>cancel</mat-icon>
        Inactive Contracts ({{ inactiveDataSource.data.length }})
      </h3>
      <table mat-table [dataSource]="inactiveDataSource" class="mat-elevation-z8">
        <ng-container matColumnDef="contract_number">
          <th mat-header-cell *matHeaderCellDef>Contract #</th>
          <td mat-cell *matCellDef="let element">{{ element.contract_number || '‚Äî' }}</td>
        </ng-container>

        <ng-container matColumnDef="customer_name">
          <th mat-header-cell *matHeaderCellDef>Customer</th>
          <td mat-cell *matCellDef="let element">{{ element.customer_name }}</td>
        </ng-container>

        <ng-container matColumnDef="unit_info">
          <th mat-header-cell *matHeaderCellDef>Unit</th>
          <td mat-cell *matCellDef="let element">{{ element.unit_info }}</td>
        </ng-container>

        <ng-container matColumnDef="start_date">
          <th mat-header-cell *matHeaderCellDef>Start</th>
          <td mat-cell *matCellDef="let element">{{ element.start_date }}</td>
        </ng-container>

        <ng-container matColumnDef="rent_amount">
          <th mat-header-cell *matHeaderCellDef>Rent</th>
          <td mat-cell *matCellDef="let element">{{ element.rent_amount }}</td>
        </ng-container>

        <ng-container matColumnDef="deposit_amount">
          <th mat-header-cell *matHeaderCellDef>Deposit</th>
          <td mat-cell *matCellDef="let element">{{ element.deposit_amount }}</td>
        </ng-container>

        <ng-container matColumnDef="payment_frequency">
          <th mat-header-cell *matHeaderCellDef>Frequency</th>
          <td mat-cell *matCellDef="let element">{{ element.payment_frequency }}</td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let element">
            <button mat-icon-button color="primary" (click)="printContract(element)" matTooltip="Print Contract">
              <mat-icon>print</mat-icon>
            </button>
            <button mat-icon-button color="primary" (click)="openEditDialog(element)" matTooltip="Edit">
              <mat-icon>edit</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="inactive-row"></tr>
      </table>
      <mat-paginator #inactivePaginator [pageSizeOptions]="[5, 10, 25]" showFirstLastButtons></mat-paginator>
    </div>
  </div>
} @else {
  @if (isLoading) {
    <div class="loading-container">
      <mat-spinner diameter="60"></mat-spinner>
      <p>Loading contracts...</p>
    </div>
  }
  @if (error) {
    <div class="error-container">
      <mat-icon color="warn">error</mat-icon>
      <p>{{ error }}</p>
    </div>
  }
}

<!-- Add Contract Dialog -->
<ng-template #openAddDialog>
  <div class="container-fluid dialog-header">
    <h2 style="display: inline;" mat-dialog-title>Add Contract</h2>
    <button style="display: inline;float: right;" mat-icon-button mat-dialog-close aria-label="Close dialog">
      <mat-icon>close</mat-icon>
    </button><br>
  
  <mat-dialog-content>
    <form [formGroup]="contractForm">
      <div class="row">
        <div class="col-md-4">
          <mat-form-field appearance="outline">
            <mat-label>Customer</mat-label>
            <mat-select formControlName="customer">
              @for (customer of customers; track customer.id) {
                <mat-option [value]="customer.id">
                  {{ customer.first_name }} {{ customer.last_name }}
                </mat-option>
              }
            </mat-select>
            @if (contractForm.get('customer')?.hasError('required')) {
              <mat-error>Customer is required</mat-error>
            }
          </mat-form-field>
        </div>

        <div class="col-md-4">
          <mat-form-field appearance="outline">
            <mat-label>Unit</mat-label>
            <mat-select formControlName="unit">
              @for (unit of filteredUnits; track unit.id) {
                <mat-option [value]="unit.id" (click)="onUnitChange(unit.id)">
                  {{ unit.unit_number }}
                </mat-option>
              }
            </mat-select>
            @if (contractForm.get('unit')?.hasError('required')) {
              <mat-error>Unit is required</mat-error>
            }
          </mat-form-field>
        </div>

        <div class="col-md-4">
          <mat-form-field appearance="outline" style="width: 100%;">
            <mat-label>Start Date</mat-label>
            <input matInput formControlName="start_date" [matDatepicker]="pickerStart">
            <mat-hint>MM/DD/YYYY</mat-hint>
            <mat-datepicker-toggle matIconSuffix [for]="pickerStart"></mat-datepicker-toggle>
            <mat-datepicker #pickerStart></mat-datepicker>
            @if (contractForm.get('start_date')?.hasError('required')) {
              <mat-error>Start date is required</mat-error>
            }
          </mat-form-field>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4">
          <mat-form-field appearance="outline">
            <mat-label>Rent Amount</mat-label>
            <input matInput type="number" formControlName="rent_amount" />
            @if (contractForm.get('rent_amount')?.hasError('required')) {
              <mat-error>Rent amount is required</mat-error>
            }
          </mat-form-field>
        </div>

        <div class="col-md-4">
          <mat-form-field appearance="outline">
            <mat-label>Deposit Amount</mat-label>
            <input matInput type="number" formControlName="deposit_amount" (change)="testData()" />
            @if (contractForm.get('deposit_amount')?.hasError('required')) {
              <mat-error>Deposit amount is required</mat-error>
            }
          </mat-form-field>
        </div>

        <div class="col-md-4">
          <mat-form-field appearance="outline">
            <mat-label>Payment Frequency</mat-label>
            <mat-select formControlName="payment_frequency">
              <mat-option value="monthly">Monthly</mat-option>
              <mat-option value="quarterly">Quarterly</mat-option>
              <mat-option value="yearly">Yearly</mat-option>
            </mat-select>
            @if (contractForm.get('payment_frequency')?.hasError('required')) {
              <mat-error>Payment frequency is required</mat-error>
            }
          </mat-form-field>
        </div>
      </div>
    </form>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-stroked-button mat-dialog-close [disabled]="loadAdding">Cancel</button>
    <button mat-flat-button color="primary" (click)="addContract()" [disabled]="loadAdding">
      @if (loadAdding) {
        <mat-spinner diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
      }
      {{ loadAdding ? 'Saving...' : 'Save' }}
    </button>
  </mat-dialog-actions>
  </div>
</ng-template>

<!-- Edit Contract Dialog -->
<ng-template #editDialog>
  <div class="container-fluid dialog-header">
    <h2 style="display: inline;" mat-dialog-title>Edit Contract</h2>
    <button style="display: inline;float: right;" mat-icon-button mat-dialog-close aria-label="Close dialog">
      <mat-icon>close</mat-icon>
    </button><br>
  
  <mat-dialog-content>
    <form [formGroup]="updateContractForm">
      <div class="row">
        <div class="col-md-4">
          <mat-form-field appearance="outline">
            <mat-label>Customer</mat-label>
            <mat-select formControlName="customer">
              @for (customer of customers; track customer.id) {
                <mat-option [value]="customer.id">
                  {{ customer.first_name }} {{ customer.last_name }}
                </mat-option>
              }
            </mat-select>
            @if (contractForm.get('customer')?.hasError('required')) {
              <mat-error>Customer is required</mat-error>
            }
          </mat-form-field>
        </div>
        
        <div class="col-md-4">
          <mat-form-field appearance="outline">
            <mat-label>Unit</mat-label>
            <mat-select formControlName="unit">
              @for (unit of units; track unit.id) {
                <mat-option [value]="unit.id">
                  {{ unit.unit_number }}
                </mat-option>
              }
            </mat-select>
            @if (contractForm.get('unit')?.hasError('required')) {
              <mat-error>Unit is required</mat-error>
            }
          </mat-form-field>
        </div>
        
        <div class="col-md-4">
          <mat-form-field appearance="outline">
            <mat-label>Start Date</mat-label>
            <input matInput type="date" formControlName="start_date" />
            @if (contractForm.get('start_date')?.hasError('required')) {
              <mat-error>Start date is required</mat-error>
            }
          </mat-form-field>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4">
          <mat-form-field appearance="outline">
            <mat-label>Rent Amount</mat-label>
            <input matInput type="number" formControlName="rent_amount" />
            @if (contractForm.get('rent_amount')?.hasError('required')) {
              <mat-error>Rent amount is required</mat-error>
            }
          </mat-form-field>
        </div>
        
        <div class="col-md-4">
          <mat-form-field appearance="outline">
            <mat-label>Deposit Amount</mat-label>
            <input matInput type="number" formControlName="deposit_amount" />
            @if (contractForm.get('deposit_amount')?.hasError('required')) {
              <mat-error>Deposit amount is required</mat-error>
            }
          </mat-form-field>
        </div>
        
        <div class="col-md-4">
          <mat-form-field appearance="outline">
            <mat-label>Payment Frequency</mat-label>
            <mat-select formControlName="payment_frequency">
              <mat-option value="monthly">Monthly</mat-option>
              <mat-option value="quarterly">Quarterly</mat-option>
              <mat-option value="yearly">Yearly</mat-option>
            </mat-select>
            @if (contractForm.get('payment_frequency')?.hasError('required')) {
              <mat-error>Payment frequency is required</mat-error>
            }
          </mat-form-field>
        </div>
      </div>
    </form>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-stroked-button mat-dialog-close [disabled]="loadUpdating">Cancel</button>
    <button mat-flat-button color="primary" (click)="updateContract()" [disabled]="loadUpdating">
      @if (loadUpdating) {
        <mat-spinner diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
      }
      {{ loadUpdating ? 'Updating...' : 'Update' }}
    </button>
  </mat-dialog-actions>
  </div>
</ng-template>

<!-- Delete Dialog -->
<ng-template #deleteDialog>
  <h2 mat-dialog-title>Delete Contract</h2>
  <mat-dialog-content>
    <p>Are you sure you want to delete this contract?</p>
    
    @if (loadDeleting) {
      <div class="loader-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Deleting...</p>
      </div>
    }
  </mat-dialog-content>
  
  <mat-dialog-actions align="end">
    <button mat-stroked-button mat-dialog-close [disabled]="loadDeleting">Cancel</button>
    <button mat-flat-button color="warn" (click)="confirmDelete()" [disabled]="loadDeleting">
      @if (loadDeleting) {
        <mat-spinner diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
      }
      {{ loadDeleting ? 'Deleting...' : 'Delete' }}
    </button>
  </mat-dialog-actions>
</ng-template>

<!-- Cancel Contract Dialog -->
<ng-template #cancelDialog>
  <h2 mat-dialog-title>Cancel Contract</h2>
  <mat-dialog-content>
    <p>Are you sure you want to cancel this contract? This action will mark the contract as inactive.</p>
    
    @if (loadCancelling) {
      <div class="loader-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Cancelling contract...</p>
      </div>
    }
  </mat-dialog-content>
  
  <mat-dialog-actions align="end">
    <button mat-stroked-button mat-dialog-close [disabled]="loadCancelling">No, Keep It</button>
    <button mat-flat-button color="accent" (click)="confirmCancel()" [disabled]="loadCancelling">
      @if (loadCancelling) {
        <mat-spinner diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
      }
      {{ loadCancelling ? 'Cancelling...' : 'Yes, Cancel Contract' }}
    </button>
  </mat-dialog-actions>
</ng-template>

<!-- Contract Preview Dialog -->
<ng-template #contractPreviewDialog> <br>
    <div class="container-fluid dialog-header">
  <h2 style="display: inline;" mat-dialog-title>PDF Preview</h2>
    <button style="display: inline;float: right;" mat-icon-button mat-dialog-close aria-label="Close dialog">
      <mat-icon>close</mat-icon>
    </button> <br>

  <mat-dialog-content>
    <div #contractPreview class="contract-preview-container">
      <!-- Header -->
      <div class="contract-header">
        <h1>Rental Contract Agreement</h1>
        <div class="contract-number">Contract #{{ selectedContract?.contract_number || 'N/A' }}</div>
        <div class="contract-meta">
          <span>üìÖ Generated: {{ contractStartDate }}</span>
          <span>üìÑ Legal Document</span>
        </div>
      </div>

      <!-- Status Badge -->
      <div class="status-section">
        <div class="status-badge" [ngClass]="selectedContract?.is_active ? 'status-active' : 'status-inactive'">
          {{ selectedContract?.is_active ? '‚úì Active Contract' : '‚úó Inactive Contract' }}
        </div>
      </div>

      <!-- Parties Section -->
      <div class="contract-section">
        <div class="section-title">üë• Parties to the Agreement</div>
        
        <h3 class="subsection-title">Tenant Information</h3>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">Full Name</div>
            <div class="info-value">{{ selectedContract?.customer_name }}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Contact Number</div>
            <div class="info-value">{{ selectedContract?.customer_phone }}</div>
          </div>
        </div>
      </div>

      <!-- Property Details -->
      <div class="contract-section">
        <div class="section-title">üè† Property Details</div>
        <div class="info-grid">
          <div class="info-item full-width">
            <div class="info-label">Rental Unit</div>
            <div class="info-value">{{ selectedContract?.unit_info }}</div>
          </div>
        </div>
      </div>

      <!-- Legal Documents -->

      <div class="contract-section">
        <div class="section-title"> Legal Documents</div>
        <div class="info-grid">
          <div class="info-item full-width">
            <div class="info-label">ID/Passport Front</div>
            <div class="info-value">
              <img style="width: 100%;" src="{{apiUrl+selectedContract?.id_photo_front }}" alt="">
              </div>
          </div>

          <div class="info-item full-width">
            <div class="info-label">ID/Passport Back</div>
            <div class="info-value">
                  <img style="width: 100%;" src="{{apiUrl+selectedContract?.id_photo_back }}" alt="">
              </div>
          </div>
        </div>
      </div>

      <!-- Contract Period -->
      <div class="contract-section">
        <div class="section-title">üìÖ Contract Period</div>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">Commencement Date</div>
            <div class="info-value">{{ contractStartDate }}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Expiration Date</div>
            <div class="info-value">{{ contractEndDate }}</div>
          </div>
          <div class="info-item full-width">
            <div class="info-label">Contract Duration</div>
            <div class="info-value">{{ contractDuration }}</div>
          </div>
        </div>
      </div>

      <!-- Financial Terms -->
      <div class="contract-section">
        <div class="section-title">üí∞ Financial Terms</div>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">Monthly Rent Amount</div>
            <div class="info-value highlight-amount">KES {{ formatCurrency(selectedContract?.rent_amount || '0') }}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Security Deposit</div>
            <div class="info-value highlight-amount">KES {{ formatCurrency(selectedContract?.deposit_amount || '0') }}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Payment Frequency</div>
            <div class="info-value">{{ selectedContract?.payment_frequency?.toUpperCase() }}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Payment Due Date</div>
            <div class="info-value">1st of every month</div>
          </div>
        </div>
        
        <h3 class="subsection-title">Payment Breakdown</h3>
        <table class="payment-table">
          <thead>
            <tr>
              <th>Description</th>
              <th>Amount (KES)</th>
              <th>Due Date</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Monthly Rent</td>
              <td>{{ formatCurrency(selectedContract?.rent_amount || '0') }}</td>
              <td>{{ selectedContract?.payment_frequency === 'monthly' ? 'Monthly' : selectedContract?.payment_frequency === 'quarterly' ? 'Quarterly' : 'Yearly' }}</td>
            </tr>
            <tr>
              <td>Security Deposit (Refundable)</td>
              <td>{{ formatCurrency(selectedContract?.deposit_amount || '0') }}</td>
              <td>Upon Contract Signing</td>
            </tr>
            <tr class="total-row">
              <td><strong>Total Initial Payment</strong></td>
              <td class="highlight-total"><strong>KES {{ totalInitialPayment }}</strong></td>
              <td><strong>Before Move-in</strong></td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Terms & Conditions -->
      <div class="contract-section">
        <div class="section-title">üìã Terms & Conditions</div>
        <ul class="terms-list">
          <li>The tenant agrees to pay rent on or before the 1st day of each month.</li>
          <li>Late payment charges of 5% will be applied after 5 days from the due date.</li>
          <li>The security deposit will be refunded within 30 days after lease termination, subject to property inspection.</li>
          <li>The tenant is responsible for maintaining the property in good condition.</li>
          <li>Any structural modifications require prior written consent from the landlord.</li>
          <li>The tenant must not sublet the property without landlord's written permission.</li>
          <li>Either party may terminate this agreement by providing 30 days written notice.</li>
          <li>The tenant must maintain adequate insurance for personal belongings.</li>
        </ul>
      </div>

      <!-- Important Notice -->
      <div class="notice-box">
        <strong>‚ö†Ô∏è Important Notice</strong>
        <p>This is a legally binding contract. Both parties should read and understand all terms before signing. It is recommended to seek legal advice if needed.</p>
      </div>

      <!-- Signature Section -->
      <div class="signature-section">
        <div class="signature-box">
          <div class="signature-title">LANDLORD / AGENT</div>
          <div class="signature-line">Signature</div>
          <div class="signature-date">Date: _____________________</div>
          <div class="signature-name">Print Name: _____________________</div>
        </div>
        
        <div class="signature-box">
          <div class="signature-title">TENANT</div>
          <div class="signature-line">Signature</div>
          <div class="signature-date">Date: _____________________</div>
          <div class="signature-name">Print Name: {{ selectedContract?.customer_name }}</div>
        </div>
      </div>

      <!-- Footer -->
      <div class="contract-footer">
        <div class="footer-content">
          <span>¬© {{ contractStartDate | date:'yyyy' }} Property Management System</span>
          <span>Contract ID: {{ selectedContract?.contract_number || 'N/A' }}</span>
        </div>
        <p class="footer-note">
          This document is computer-generated and valid without signature if electronically signed.
        </p>
      </div>
    </div>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>Close</button>
    <button mat-raised-button color="primary" (click)="generateContractPDF()">
      <mat-icon>download</mat-icon>
      Download PDF
    </button>
  </mat-dialog-actions>
  </div>
</ng-template>