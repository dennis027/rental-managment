<div class="payments-container">
  <div class="header">
    <h2><i class="fas fa-money-bill-wave"></i> Payments</h2>
    <button mat-raised-button color="primary" (click)="openAddPaymentDialog()">
      <mat-icon>add</mat-icon> Add Payment
    </button>
  </div>

  <div class="table-container mat-elevation-z8">
    <table mat-table [dataSource]="dataSource" class="full-width-table">

      <!-- Amount -->
      <ng-container matColumnDef="amount">
        <th mat-header-cell *matHeaderCellDef>Amount</th>
        <td mat-cell *matCellDef="let element">{{ element.amount | currency:'KES' }}</td>
      </ng-container>

      <!-- Date -->
      <ng-container matColumnDef="payment_date">
        <th mat-header-cell *matHeaderCellDef>Date</th>
        <td mat-cell *matCellDef="let element">{{ element.payment_date | date }}</td>
      </ng-container>

      <!-- Method -->
      <ng-container matColumnDef="method">
        <th mat-header-cell *matHeaderCellDef>Method</th>
        <td mat-cell *matCellDef="let element">{{ element.method | titlecase }}</td>
      </ng-container>

      <!-- Reference -->
      <ng-container matColumnDef="reference">
        <th mat-header-cell *matHeaderCellDef>Reference</th>
        <td mat-cell *matCellDef="let element">{{ element.reference }}</td>
      </ng-container>

      <!-- Notes -->
      <ng-container matColumnDef="notes">
        <th mat-header-cell *matHeaderCellDef>Notes</th>
        <td mat-cell *matCellDef="let element">{{ element.notes || '-' }}</td>
      </ng-container>

      <!-- Contract -->
      <ng-container matColumnDef="contract">
        <th mat-header-cell *matHeaderCellDef>Contract</th>
        <td mat-cell *matCellDef="let element">{{ element.contract }}</td>
      </ng-container>

      <!-- Actions -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let element">
          <button mat-icon-button color="primary" matTooltip="Edit">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button color="warn" matTooltip="Delete">
            <mat-icon>delete</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

      @if (dataSource.data.length === 0) {
        <tr class="mat-row">
          <td class="mat-cell" [attr.colspan]="displayedColumns.length">
            <div class="no-data">
              <mat-icon>inbox</mat-icon>
              <p>No payments found</p>
            </div>
          </td>
        </tr>
      }
    </table>

    <mat-paginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>
  </div>
</div>

<!-- Add Payment Dialog -->
<ng-template #addPaymentDialog>
  <h2 mat-dialog-title>Add Payment</h2>
  <mat-dialog-content>
    <form [formGroup]="addPaymentForm" class="payment-form">

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Amount</mat-label>
        <input matInput type="number" formControlName="amount" placeholder="e.g., 25000">
        @if (addPaymentForm.get('amount')?.hasError('required')) {
          <mat-error>Amount is required</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Payment Date</mat-label>
        <input matInput type="date" formControlName="payment_date">
        @if (addPaymentForm.get('payment_date')?.hasError('required')) {
          <mat-error>Date is required</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Payment Method</mat-label>
        <mat-select formControlName="method">
          <mat-option value="mpesa">M-Pesa</mat-option>
          <mat-option value="bank">Bank</mat-option>
          <mat-option value="cash">Cash</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Reference</mat-label>
        <input matInput formControlName="reference" placeholder="MPESA12345">
        @if (addPaymentForm.get('reference')?.hasError('required')) {
          <mat-error>Reference is required</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Notes</mat-label>
        <textarea matInput formControlName="notes" rows="2" placeholder="Optional notes"></textarea>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Contract ID</mat-label>
        <input matInput type="number" formControlName="contract" placeholder="e.g., 2">
        @if (addPaymentForm.get('contract')?.hasError('required')) {
          <mat-error>Contract ID is required</mat-error>
        }
      </mat-form-field>

    </form>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>Cancel</button>
    <button mat-raised-button color="primary" (click)="addPayment()" [disabled]="addPaymentForm.invalid || loadAdding">
      @if (loadAdding) {
        <mat-spinner diameter="20"></mat-spinner>
      }
      @if (!loadAdding) {
        <span>Add Payment</span>
      }
    </button>
  </mat-dialog-actions>
</ng-template>
