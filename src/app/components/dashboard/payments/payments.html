<div class="payments-container">
  <div class="header">
    <h2><i class="fas fa-money-bill-wave"></i> Payments</h2>
    
    <div class="header-actions">
      <mat-form-field appearance="outline" class="month-filter">
        <mat-label>Filter by Month</mat-label>
        <mat-select [formControl]="selectedMonth">
          <mat-option value="">All Months</mat-option>
          @for (month of availableMonths; track month.value) {
            <mat-option [value]="month.value">
              {{ month.display }}
            </mat-option>
          }
        </mat-select>
      </mat-form-field>

      @if (properties.length > 1) {
        <mat-form-field appearance="outline" class="property-filter">
          <mat-label>Filter by Property</mat-label>
          <mat-select [formControl]="selectedProperty">
            @for (property of properties; track property.id) {
              <mat-option [value]="property.id.toString()">
                {{ property.name }}
              </mat-option>
            }
          </mat-select>
        </mat-form-field>
      }

      <!-- <button mat-raised-button color="primary" (click)="openAddPaymentDialog()">
        <mat-icon>add</mat-icon> Add Payment
      </button> -->
    </div>
  </div>

  <div class="payment-summary">
    <span class="summary-text">
      Showing {{ incomingPayments.length + outgoingPayments.length }} payment(s)
      @if (selectedMonth.value) {
        <span> for {{ getSelectedMonthDisplay() }}</span>
      }
      @if (selectedProperty.value) {
        <span> in {{ getPropertyName(selectedProperty.value) }}</span>
      }
    </span>
  </div>

  <!-- Incoming Payments Table -->
  <h3 style="margin-top: 24px; margin-bottom: 8px; color: #4caf50; display: flex; align-items: center; gap: 8px;">
    <mat-icon style="vertical-align: middle;">arrow_downward</mat-icon>
    <span>Incoming Payments ({{ incomingPayments.length }})</span>
  </h3>
  <div class="table-container mat-elevation-z8">
    <table mat-table [dataSource]="incomingDataSource" class="full-width-table" ngSkipHydration>

      <!-- Customer Name -->
      <ng-container matColumnDef="customer_name">
        <th mat-header-cell *matHeaderCellDef>Customer</th>
        <td mat-cell *matCellDef="let element" [attr.data-label]="'Customer'">{{ element.customer_name }}</td>
      </ng-container>

      <!-- Unit -->
      <ng-container matColumnDef="unit_name">
        <th mat-header-cell *matHeaderCellDef>Unit</th>
        <td mat-cell *matCellDef="let element" [attr.data-label]="'Unit'">{{ element.unit_name }}</td>
      </ng-container>

      <!-- Amount -->
      <ng-container matColumnDef="amount">
        <th mat-header-cell *matHeaderCellDef>Amount</th>
        <td mat-cell *matCellDef="let element" [attr.data-label]="'Amount'">{{ element.amount | number:'1.2-2' }}</td>
      </ng-container>

      <!-- Date -->
      <ng-container matColumnDef="payment_date">
        <th mat-header-cell *matHeaderCellDef>Date</th>
        <td mat-cell *matCellDef="let element" [attr.data-label]="'Date'">{{ element.payment_date | date }}</td>
      </ng-container>

      <!-- Method -->
      <ng-container matColumnDef="method">
        <th mat-header-cell *matHeaderCellDef>Method</th>
        <td mat-cell *matCellDef="let element" [attr.data-label]="'Method'">{{ element.method | titlecase }}</td>
      </ng-container>

      <!-- Reference -->
      <ng-container matColumnDef="reference">
        <th mat-header-cell *matHeaderCellDef>Reference</th>
        <td mat-cell *matCellDef="let element" [attr.data-label]="'Reference'">{{ element.reference }}</td>
      </ng-container>

      <!-- Receipt -->
      <ng-container matColumnDef="receipt_number">
        <th mat-header-cell *matHeaderCellDef>Receipt</th>
        <td mat-cell *matCellDef="let element" [attr.data-label]="'Receipt'">{{ element.receipt_number }}</td>
      </ng-container>

      <!-- Actions -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let element">
          <button mat-icon-button color="primary" matTooltip="Edit">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button color="warn" matTooltip="Delete">
            <mat-icon>delete</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="incomingColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: incomingColumns"></tr>

      @if (incomingDataSource.data.length === 0) {
        <tr class="mat-row">
          <td class="mat-cell" [attr.colspan]="incomingColumns.length">
            <div class="no-data">
              <mat-icon>inbox</mat-icon>
              <p>No incoming payments found</p>
            </div>
          </td>
        </tr>
      }
    </table>

    <mat-paginator #incomingPaginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>
  </div>

  <!-- Outgoing Payments Table -->
  <h3 style="margin-top: 32px; margin-bottom: 8px; color: #f44336; display: flex; align-items: center; gap: 8px;">
    <mat-icon style="vertical-align: middle;">arrow_upward</mat-icon>
    <span>Outgoing Payments ({{ outgoingPayments.length }})</span>
  </h3>
  <div class="table-container mat-elevation-z8">
    <table mat-table [dataSource]="outgoingDataSource" class="full-width-table" ngSkipHydration>

      <!-- Customer Name -->
      <ng-container matColumnDef="customer_name">
        <th mat-header-cell *matHeaderCellDef>Payee</th>
        <td mat-cell *matCellDef="let element" [attr.data-label]="'Payee'">{{ element.customer_name }}</td>
      </ng-container>

      <!-- Unit -->
      <ng-container matColumnDef="unit_name">
        <th mat-header-cell *matHeaderCellDef>Unit</th>
        <td mat-cell *matCellDef="let element"[attr.data-label]="'Unit'">{{ element.unit_name }}</td>
      </ng-container>

      <!-- Amount -->
      <ng-container matColumnDef="amount">
        <th mat-header-cell *matHeaderCellDef>Amount</th>
        <td mat-cell *matCellDef="let element"[attr.data-label]="'Amount'">{{ element.amount | number:'1.2-2' }}</td>
      </ng-container>

      <!-- Date -->
      <ng-container matColumnDef="payment_date">
        <th mat-header-cell *matHeaderCellDef>Date</th>
        <td mat-cell *matCellDef="let element"[attr.data-label]="'Date'">{{ element.payment_date | date }}</td>
      </ng-container>

      <!-- Method -->
      <ng-container matColumnDef="method">
        <th mat-header-cell *matHeaderCellDef>Method</th>
        <td mat-cell *matCellDef="let element"[attr.data-label]="'Method'">{{ element.method | titlecase }}</td>
      </ng-container>

      <!-- Reference -->
      <ng-container matColumnDef="reference">
        <th mat-header-cell *matHeaderCellDef>Reference</th>
        <td mat-cell *matCellDef="let element"[attr.data-label]="'Reference'">{{ element.reference }}</td>
      </ng-container>

      <!-- Notes -->
      <ng-container matColumnDef="notes">
        <th mat-header-cell *matHeaderCellDef>Notes</th>
        <td mat-cell *matCellDef="let element"[attr.data-label]="'Notes'">{{ element.notes || '-' }}</td>
      </ng-container>

      <!-- Actions -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let element">
          <button mat-icon-button color="primary" matTooltip="Edit">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button color="warn" matTooltip="Delete">
            <mat-icon>delete</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="outgoingColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: outgoingColumns"></tr>

      @if (outgoingDataSource.data.length === 0) {
        <tr class="mat-row">
          <td class="mat-cell" [attr.colspan]="outgoingColumns.length">
            <div class="no-data">
              <mat-icon>inbox</mat-icon>
              <p>No outgoing payments found</p>
            </div>
          </td>
        </tr>
      }
    </table>

    <mat-paginator #outgoingPaginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>
  </div>
</div>

<!-- Add Payment Dialog -->
<ng-template #addPaymentDialog>
  <h2 mat-dialog-title>Add Payment</h2>
  <mat-dialog-content>
    <form [formGroup]="addPaymentForm" class="payment-form">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Payment Type</mat-label>
        <mat-select formControlName="type">
          <mat-option value="IN">Money In (Incoming)</mat-option>
          <mat-option value="OUT">Money Out (Outgoing)</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Amount</mat-label>
        <input matInput type="number" formControlName="amount" placeholder="e.g., 25000">
        @if (addPaymentForm.get('amount')?.hasError('required')) {
          <mat-error>Amount is required</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Payment Date</mat-label>
        <input matInput type="date" formControlName="payment_date">
        @if (addPaymentForm.get('payment_date')?.hasError('required')) {
          <mat-error>Date is required</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Payment Method</mat-label>
        <mat-select formControlName="method">
          <mat-option value="mpesa">M-Pesa</mat-option>
          <mat-option value="bank">Bank</mat-option>
          <mat-option value="cash">Cash</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Reference</mat-label>
        <input matInput formControlName="reference" placeholder="MPESA12345">
        @if (addPaymentForm.get('reference')?.hasError('required')) {
          <mat-error>Reference is required</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Notes</mat-label>
        <textarea matInput formControlName="notes" rows="2" placeholder="Optional notes"></textarea>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Contract ID</mat-label>
        <input matInput type="number" formControlName="contract" placeholder="e.g., 2">
        @if (addPaymentForm.get('contract')?.hasError('required')) {
          <mat-error>Contract ID is required</mat-error>
        }
      </mat-form-field>
    </form>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>Cancel</button>
    <button mat-raised-button color="primary" (click)="addPayment()" [disabled]="addPaymentForm.invalid || loadAdding">
      @if (loadAdding) {
        <mat-spinner diameter="20"></mat-spinner>
      }
      @if (!loadAdding) {
        <span>Add Payment</span>
      }
    </button>
  </mat-dialog-actions>
</ng-template>